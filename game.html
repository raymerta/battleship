<html>
	<head>
		<title>BATTLESHIP</title>
		<link rel="stylesheet" type="text/css" href="http://parallemon.com/battleship/battleshipstyle.css">
		<!-- <link rel="stylesheet" type="text/css" href="battleshipstyle.css"> -->
		<link href="https://fonts.googleapis.com/css?family=Roboto+Slab:100,300,400,700" rel="stylesheet">
	</head>

	<body>

		<div class="skybackground">
			<img src="http://parallemon.com/battleship/title.png">
		</div>
		<div class="notification">
			<div class="gamecontainer" id="notifContent">you are in editing mode</div>
		</div>
		<div class="seabackground">
			<div class="gamecontainer">
				
				<p>Server selected : <span id="serverName" class="emphasize"></span> - Game : </p>

				<h1 class="servername" id="gameName">Baltic Sea 1</h1>

				<div id="placeShips">
				<div class="ship battleship" id="battleship" onclick="selectShip('battleship')">Battleship (1)</div> 
				<div class="ship cruiser" id="cruiser" onclick="selectShip('cruiser')">Cruiser (2)</div>
				<div class="ship destroyer" id="destroyer" onclick="selectShip('destroyer')">Destroyer (3)</div>
				<div class="ship submarine" id="submarine" onclick="selectShip('submarine')">Submarine (4)</div>
				</div>
				<div class="clearfix"></div>
			</div>
		</div>

		<div id="map"></div>

		<div class="clearfix"></div>

		
		<a href="#" id="saveGame"><div class="gamebutton" onclick="saveGame()">Start Game</div></a>

		<script type="text/javascript">

			var mapSize = 10;
			var numPlayer = 2;

			var server = '';
			var uri = window.location.pathname.split('/');

			function getServerDetail() {
				var http = new XMLHttpRequest();
				var url = "http://localhost:10001/_getservername/" + uri[2];
				http.open("GET", url);

				//capture success response
				http.onreadystatechange = function() {
					if (http.readyState == 4 && http.status == 200) {
						server = JSON.parse(http.responseText);
						document.getElementById("serverName").innerHTML = server.serverName;
					}
				}

				http.send();
			}

			getServerDetail();

			function getGameInfo() {
				var http = new XMLHttpRequest();
				var url = "http://localhost:10001/_getGameInfo/" + uri[4];
				http.open("GET", url);

				//capture success response
				http.onreadystatechange = function() {
					if (http.readyState == 4 && http.status == 200) {
						if (http.responseText != "None") {
							game = JSON.parse(http.responseText.trim());
							console.log(game);

							mapSize = game.size;
							document.getElementById("gameName").innerHTML = game.roomName;
							generateMap();
						}
					}
				}

				http.send();
			}

			getGameInfo();

			var shipSelected = '';
			var ship = new Array();

			ship['battleship'] = {
				size: 4,
				color: "#f8b823",
				placed: 0,
				qty: 1
			}

			ship['cruiser'] = {
				size: 3,
				color: "#ff842f",
				placed: 0,
				qty: 2
			}

			ship['destroyer'] = {
				size: 2,
				color: "#ff6c54",
				placed: 0,
				qty: 3
			}

			ship['submarine'] = {
				size: 1,
				color: "#26d2b5",
				placed: 0,
				qty: 4
			}

			var firstPos = "";
			var secondPos = [];

			function generateMap() {
				document.getElementById("map").style.width = (mapSize * 54) + "px";
				document.getElementById("map").style.margin = "0 auto 20px auto";

				var mapBlock = "";
				var blockSize = mapSize * mapSize;

				for (var i = 0; i < blockSize; i++) {
					mapBlock = mapBlock + "<div class=\"seablock\" id=\"" + i + "\" onclick=\"seaPos("+i+")\"></div>";
				}

				document.getElementById("map").innerHTML = mapBlock;
			}

			function selectShip(shipName) {

				if (ship[shipName].placed < ship[shipName].qty) {
					if (shipSelected != "") {
						document.getElementById(shipSelected).style.border = "3px solid " + ship[shipSelected].color;	
					}
					document.getElementById(shipName).style.border = "3px solid white";
					shipSelected = shipName;
				} else {
					alert("maximum number of ship reached");
				}
			}

			// create lighter color for dropping ships
			function droppingShipRange(pos) {
				var modulo = pos % mapSize;
				var div = Math.floor(pos / mapSize); 

				var newPos = '';

				//left
				if ((modulo - (ship[shipSelected].size - 1)) >= 0) {
					newPos = pos - 1;

					secondPos.push(newPos);
					document.getElementById(newPos).style.background = "url(\"http://parallemon.com/battleship/seasec.png\")";
				}

				//right
				if ((modulo + (ship[shipSelected].size - 1)) < mapSize) {
					newPos = pos + 1;

					secondPos.push(newPos);
					document.getElementById(newPos).style.background = "url(\"http://parallemon.com/battleship/seasec.png\")";
				}

				//top
				if ((div - (ship[shipSelected].size - 1)) >= 0) {
					newPos = (div - 1) * mapSize + modulo;

					secondPos.push(newPos);
					document.getElementById(newPos).style.background = "url(\"http://parallemon.com/battleship/seasec.png\")";
				}

				//bottom
				if ((div + (ship[shipSelected].size - 1)) >= 0) {
					newPos = (div + 1) * mapSize + modulo;
					
					secondPos.push(newPos);
					document.getElementById(newPos).style.background = "url(\"http://parallemon.com/battleship/seasec.png\")";
				}
			}

			// positioning battleship
			function seaPos(pos) {

				if (shipSelected != "") {

					if (secondPos.length > 0) {
						if (secondPos.indexOf(pos) > -1) {

							//remove light color placement
							for (var i = 0; i < secondPos.length; i++) {
								var remPos = secondPos[i];
								document.getElementById(remPos).style.background = "url(\"http://parallemon.com/battleship/seablock.png\")";
							}

							// put color in selection
							document.getElementById(pos).style.background = ship[shipSelected].color;

							// draw the rest of ship body
							if (ship[shipSelected].size - 2 > 0) {

								var diff = pos - firstPos;
								var curr = pos + diff;

								for (var i = 0; i < ship[shipSelected].size - 2; i++) {
									document.getElementById(curr).style.background = ship[shipSelected].color;
									curr = curr + diff;
								}
							}

							//reset all value 
							secondPos = [];
							firstPos = '';

							//reset button
							document.getElementById(shipSelected).style.border = "3px solid " + ship[shipSelected].color;

							//increase placed number
							ship[shipSelected].placed = ship[shipSelected].placed + 1;
							document.getElementById(shipSelected).innerHTML = shipSelected + " (" + (ship[shipSelected].qty - ship[shipSelected].placed) + ")";

							//reset if ship selected already all placed
							shipSelected = '';

							//change color of button if already reach maximum quantity

						} else {
							alert("you must select in destined area");
						}
					} else {
						document.getElementById(pos).style.background = ship[shipSelected].color;
						
						if (ship[shipSelected].size > 1) {
							firstPos = pos;
							droppingShipRange(pos);
						} else {
							//reset button
							document.getElementById(shipSelected).style.border = "3px solid " + ship[shipSelected].color;

							//increase placed number
							ship[shipSelected].placed = ship[shipSelected].placed + 1;
							document.getElementById(shipSelected).innerHTML = shipSelected + " (" + (ship[shipSelected].qty - ship[shipSelected].placed) + ")";

							//reset if ship selected already all placed
							shipSelected = '';
						}
					}

				} else {
					alert("you must choose the ship");
				}
			}


			function saveGame() {
				document.getElementById("placeShips").style.display = "none";
				document.getElementById("notifContent").innerHTML = "Game Ready";
				document.getElementById("saveGame").style.display = "none";
			}

		</script>

	</body>
</html>