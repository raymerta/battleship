<html>
	<head>
		<title>BATTLESHIP</title>
		<link rel="stylesheet" type="text/css" href="http://parallemon.com/battleship/battleshipstyle.css">
		<link href="https://fonts.googleapis.com/css?family=Roboto+Slab:100,300,400,700" rel="stylesheet">

		<script type="text/javascript" src="http://parallemon.com/battleship/sockjs-0.3.js"></script>
		<script type="text/javascript" src="http://parallemon.com/battleship/stomp.js"></script>
	</head>

	<body>

		<div class="skybackground">
			<img src="http://parallemon.com/battleship/title.png">
		</div>
		<div class="notification">
			<div class="gamecontainer" id="notifContent">you are in editing mode</div>
		</div>
		<div class="seabackground">
			<div class="gamecontainer">
				
				<p>Server selected : <span id="serverName" class="emphasize"></span> - Game : </p>

				<h1 class="servername" id="gameName"></h1>

				<div id="placeShips">
				<div class="ship battleship" id="battleship" onclick="selectShip('battleship')">Battleship (1)</div> 
				<div class="ship cruiser" id="cruiser" onclick="selectShip('cruiser')">Cruiser (2)</div>
				<div class="ship destroyer" id="destroyer" onclick="selectShip('destroyer')">Destroyer (3)</div>
				<div class="ship submarine" id="submarine" onclick="selectShip('submarine')">Submarine (4)</div>
				</div>
				<div class="clearfix"></div>
			</div>
		</div>

		<div id="map"></div>

		<div class="clearfix"></div>
		
		<a href="#" id="saveGame"><div class="gamebutton" onclick="saveGame()">Start Game</div></a>

		<div class="blackdrop" id="blackDrop">
			<div class="newgamebox">
				<p style="margin-bottom: 10px">Game Information:</p>
				<h1 id="popupGameName"></h1>
				<table>
					<tr>
						<td>Created by :</td>
						<td id="pCreator"></td>
					</tr>
					<tr>
						<td>Maximum Players :</td>
						<td><span id="pPlayer"></span> players ( <span id="pInGame"></span> in game )</td>
					</tr>
				</table>
				<a href="#" class="newgamecancel" onclick="watch()">WATCH</a><a href="#" class="newgamesubmit" id="pJoin">JOIN</a>
				<div class="clearfix"></div>
			</div>
		</div>

		<script type="text/javascript">

			var mapSize = 10;
			var isEditing = true;
			var isWatching = false;
			var isPlaying = false;

			var server = '';
			var uri = window.location.pathname.split('/');

			var messages = [];
			messages[0] = "In Editing Mode";
			messages[1] = "Game Ready, Waiting for player";
			messages[2] = "Game is Running, Current Turn : ";


			function getServerDetail() {
				var http = new XMLHttpRequest();
				var url = "http://localhost:10001/_getservername/" + uri[2];
				http.open("GET", url);

				//capture success response
				http.onreadystatechange = function() {
					if (http.readyState == 4 && http.status == 200) {
						server = JSON.parse(http.responseText);
						document.getElementById("serverName").innerHTML = server.serverName;
						getGameInfo();
					}
				}

				http.send();
			}

			getServerDetail();

			function getGameInfo() {
				var http = new XMLHttpRequest();
				var url = "http://localhost:10001/_getGameInfo/" + uri[4];
				http.open("GET", url);

				//capture success response
				http.onreadystatechange = function() {
					if (http.readyState == 4 && http.status == 200) {
						if (http.responseText != "None") {
							game = JSON.parse(http.responseText.trim());
							console.log(game);

							mapSize = game.size;
							var d = new Date(0); 
							d.setUTCSeconds(game.roomCreated);

							document.getElementById("gameName").innerHTML = game.roomName;
							document.getElementById("popupGameName").innerHTML = game.roomName;
							document.getElementById("pCreator").innerHTML = game.creator;
							document.getElementById("pPlayer").innerHTML = game.numPlayers;
							document.getElementById("pInGame").innerHTML = game.users.length;
							
							//generate Map
							generateMap();

							if (game.users.length == game.numPlayers) {
								document.getElementById("pJoin").style.display = "none";
							}

							//isJoined or not, if yes toggle off editing mode
							var user = getUserInfo(game.users, uri[3]);
							if (user == '') {
								document.getElementById("placeShips").style.display = "none";
								document.getElementById("notifContent").innerHTML = "Game Ready";
								document.getElementById("saveGame").style.display = "none";
								isEditing = false;
								isWatching = true;

							} else {
								document.getElementById("blackDrop").style.display = "none";
							}
						}
					}
				}

				http.send();
			}

			function watch() {
				isWatching = true;
				document.getElementById("blackDrop").style.display = "none";
			}

			function getUserInfo(users, username) {
				for (var i = 0; i < users.length; i++) {
					if (users[i].username == username) {
						return users[i];
					}
				}

				return '';
			}

			var shipSelected = '';
			var ship = new Array();

			ship['battleship'] = {
				size: 4,
				color: "#f8b823",
				placed: 0,
				qty: 1,
				coor: []
			}

			ship['cruiser'] = {
				size: 3,
				color: "#ff842f",
				placed: 0,
				qty: 2,
				coor: []
			}

			ship['destroyer'] = {
				size: 2,
				color: "#ff6c54",
				placed: 0,
				qty: 3,
				coor: []
			}

			ship['submarine'] = {
				size: 1,
				color: "#26d2b5",
				placed: 0,
				qty: 4,
				coor: []
			}

			var firstPos = "";
			var secondPos = [];

			function generateMap() {
				document.getElementById("map").style.width = (mapSize * 54) + "px";
				document.getElementById("map").style.margin = "0 auto 20px auto";

				var mapBlock = "";
				var blockSize = mapSize * mapSize;

				for (var i = 0; i < blockSize; i++) {
					mapBlock = mapBlock + "<div class=\"seablock\" id=\"" + i + "\" onclick=\"seaPos("+i+")\"></div>";
				}

				document.getElementById("map").innerHTML = mapBlock;
			}

			function selectShip(shipName) {

				if (ship[shipName].placed < ship[shipName].qty) {
					if (shipSelected != "") {
						document.getElementById(shipSelected).style.border = "3px solid " + ship[shipSelected].color;	
					}
					document.getElementById(shipName).style.border = "3px solid white";
					shipSelected = shipName;
				} else {
					alert("maximum number of ship reached");
				}
			}

			// create lighter color for dropping ships
			function droppingShipRange(pos) {
				var modulo = pos % mapSize;
				var div = Math.floor(pos / mapSize); 

				var newPos = '';

				//left
				if ((modulo - (ship[shipSelected].size - 1)) >= 0) {
					newPos = pos - 1;

					secondPos.push(newPos);
					document.getElementById(newPos).style.background = "url(\"http://parallemon.com/battleship/seasec.png\")";
				}

				//right
				if ((modulo + (ship[shipSelected].size - 1)) < mapSize) {
					newPos = pos + 1;

					secondPos.push(newPos);
					document.getElementById(newPos).style.background = "url(\"http://parallemon.com/battleship/seasec.png\")";
				}

				//top
				if ((div - (ship[shipSelected].size - 1)) >= 0) {
					newPos = (div - 1) * mapSize + modulo;

					secondPos.push(newPos);
					document.getElementById(newPos).style.background = "url(\"http://parallemon.com/battleship/seasec.png\")";
				}

				//bottom
				if ((div + (ship[shipSelected].size - 1)) >= 0) {
					newPos = (div + 1) * mapSize + modulo;
					
					secondPos.push(newPos);
					document.getElementById(newPos).style.background = "url(\"http://parallemon.com/battleship/seasec.png\")";
				}
			}

			function placementLogic(pos) {
				if (shipSelected != "") {
					if (secondPos.length > 0) {
						if (secondPos.indexOf(pos) > -1) {

							//remove light color placement
							for (var i = 0; i < secondPos.length; i++) {
								var remPos = secondPos[i];
								document.getElementById(remPos).style.background = "url(\"http://parallemon.com/battleship/seablock.png\")";
							}

							// put color in selection
							document.getElementById(pos).style.background = ship[shipSelected].color;
							ship[shipSelected].coor.push(pos);

							// draw the rest of ship body
							if (ship[shipSelected].size - 2 > 0) {

								var diff = pos - firstPos;
								var curr = pos + diff;

								for (var i = 0; i < ship[shipSelected].size - 2; i++) {
									document.getElementById(curr).style.background = ship[shipSelected].color;
									ship[shipSelected].coor.push(curr);
									curr = curr + diff;
								}
							}

							//reset all value 
							secondPos = [];
							firstPos = '';

							//reset button
							document.getElementById(shipSelected).style.border = "3px solid " + ship[shipSelected].color;

							//increase placed number
							ship[shipSelected].placed = ship[shipSelected].placed + 1;
							document.getElementById(shipSelected).innerHTML = shipSelected + " (" + (ship[shipSelected].qty - ship[shipSelected].placed) + ")";

							//reset if ship selected already all placed
							shipSelected = '';

							//change color of button if already reach maximum quantity

						} else {
							alert("you must select in destined area");
						}
					} else {
						document.getElementById(pos).style.background = ship[shipSelected].color;
						ship[shipSelected].coor.push(pos);
						
						if (ship[shipSelected].size > 1) {
							firstPos = pos;
							droppingShipRange(pos);
						} else {
							//reset button
							document.getElementById(shipSelected).style.border = "3px solid " + ship[shipSelected].color;

							//increase placed number
							ship[shipSelected].placed = ship[shipSelected].placed + 1;
							document.getElementById(shipSelected).innerHTML = shipSelected + " (" + (ship[shipSelected].qty - ship[shipSelected].placed) + ")";

							//reset if ship selected already all placed
							shipSelected = '';
						}
					}

				} else {
					alert("you must choose the ship");
				}
			}

			function clickingPos() {
				
			}

			function saveGame() {
				document.getElementById("placeShips").style.display = "none";
				document.getElementById("notifContent").innerHTML = "Game Ready";
				document.getElementById("saveGame").style.display = "none";
				isEditing = false;
				isPlaying = true;
				console.log(ship);
			}

			// rabbitmq

			// Use SockJS
			Stomp.WebSocketClass = SockJS;

			// Connection parameters
			var mq_username = "guest";
			var mq_password = "guest";
			var mq_vhost = "/";
			var mq_url = 'http://localhost:15674/stomp';

			    //topic name
			var mq_queue = "/topic/play-" + uri[4];
			var mq_ctype = {"content-type":"text/plain"};

			// This is where we print incomoing messages
			var output;

			// This will be called upon successful connection
			function on_connect() {
				console.log('connected');
				console.log(client);
				console.log(mq_queue);
			  	client.subscribe(mq_queue, on_message);
			}

			// This will be called upon a connection error
			function on_connect_error() {
				console.log(client);
				console.log("connection error");
			}

			// This will be called upon arrival of a message
			function on_message(m) {
			  	console.log('message received');
			  	pos = m.body.trim();
			  	document.getElementById(pos).style.background = "linear-gradient(rgba(41, 41, 41, 0.5), rgba(41, 41, 41, 0.5)), url('http://parallemon.com/battleship/seablock.png')";
			}

			// Create a client
			var client = Stomp.client(mq_url);

			client.connect(mq_username, mq_password, on_connect, on_connect_error, mq_vhost);


			// positioning battleship & clicking battleship
			function seaPos(pos) {
				if (isEditing == true) {
					placementLogic(pos);	
				}

				if (isPlaying == true) {
					console.log("clicking");
					client.send(mq_queue, {"content-type":"text/plain"}, pos);
					document.getElementById(pos).style.background = "linear-gradient(rgba(41, 41, 41, 0.5), rgba(41, 41, 41, 0.5)), url('http://parallemon.com/battleship/seablock.png')";
				}

				if (isWatching == true) {
					
				}
			}

		</script>

	</body>
</html>